<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clicky Mini Demo</title>
</head>

<body style="background: #fff; font-family: sans-serif; padding: 50px;">
    <h1>Clicky Mini Mode</h1>
    <p>This page initializes Clicky in MINI mode (default).</p>

    <!-- Login Form -->
    <div id="login-form" style="border: 1px solid #ccc; padding: 20px; max-width: 300px; margin-bottom: 20px;">
        <h3>Login to Clicktory</h3>
        <input type="email" id="email" placeholder="Email" value="slikeqa@gmail.com"
            style="display:block; width: 100%; margin-bottom: 10px; padding: 5px;">
        <input type="password" id="password" placeholder="Password" value="naveen9291"
            style="display:block; width: 100%; margin-bottom: 10px; padding: 5px;">
        <button id="login-btn" style="padding: 5px 10px;">Login</button>
        <p id="login-error" style="color: red; display: none;"></p>
    </div>

    <!-- Persistent Container for Full Mode -->
    <div id="rex-widget-container" style="
       position: fixed; 
        bottom: 20px; 
        right: 20px; 
        max-width:800px;
        min-width: 200px;   
        width: calc(90% - 200px); 
        max-height: 800px;
        min-height: 400px;
        height: calc(90% - 300px); 
        z-index: 9999; 
        border: 1px dashed #ccc; 
        display: flex; 
        flex-direction: column;
        ">
    </div>

    <script src="./clickysdk.js"></script>
    <script>
        const loginBtn = document.getElementById('login-btn');
        const loginForm = document.getElementById('login-form');
        const errorMsg = document.getElementById('login-error');


        function bodyonload() {
            var isLogin = checkLogin();
            if (isLogin) {
                loginForm.style.display = 'none';
            } else {
                loginBtn.addEventListener('click', onLogin);
            }
        }


        async function onLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            errorMsg.style.display = 'none';
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;

            try {
                // Assuming AppServer is on Port 5000 based on standard conventions
                // If AppServer is on a different port, update the fetch URL below.
                const res = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const responseData = await res.json();

                if (!res.ok) {
                    throw new Error(responseData.message || 'Login failed');
                }

                // FIX: API returns { success: true, data: { token: "..." } }
                // We must access responseData.data.token
                const token = responseData.data?.token || responseData.token;
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(responseData.data));

                if (!token) {
                    console.error('Full Response:', responseData);
                    throw new Error('No token received');
                }

                // Initialize Clicky with Real Token
                console.log('Got Token:', token);

                var clickyObj = new ClickyBot({
                    mode: 'full',
                    token: token,
                    serverUrl: 'http://localhost:5003', // BotServer
                    context: {
                        page: 'full_demo'
                    },
                    containerId: 'rex-widget-container' // Explicit container
                });

                let status = clickyObj.mount()
                if (!status) {
                    console.error('Clicky failed to mount');
                    return;
                } else {
                    console.log('Clicky mounted successfully');
                }
                var data = responseData.data;


                // Hide login form after success
                loginForm.style.display = 'none';
                const successMsg = document.createElement('p');
                successMsg.textContent = `Logged in as ${data.user ? data.user.name : 'User'}. Clicky Initialized!`;
                successMsg.style.color = 'green';
                document.body.insertBefore(successMsg, document.body.firstChild);

            } catch (err) {
                console.error(err);
                errorMsg.textContent = err.message;
                errorMsg.style.display = 'block';
            } finally {
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
            }
        }


        function checkLogin() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));
            if (token && user) {
                //make 
                // Initialize Clicky with Real Token
                console.log('Got Token:', token);

                var clickyObj = new ClickyBot({
                    mode: 'full',
                    token: token,
                    serverUrl: 'http://localhost:5003', // BotServer
                    context: {
                        page: 'full_demo'
                    },
                    containerId: 'rex-widget-container' // Explicit container
                });

                let status = clickyObj.mount()
                if (!status) {
                    console.error('Clicky failed to mount');
                    return;
                } else {
                    console.log('Clicky mounted successully');
                }

                // Hide login form after success
                loginForm.style.display = 'none';
                const successMsg = document.createElement('p');
                successMsg.textContent = `Logged in as ${user.name}. Clicky Initialized!`;
                successMsg.style.color = 'green';
                document.body.insertBefore(successMsg, document.body.firstChild);
            }
        }




        document.addEventListener('DOMContentLoaded', bodyonload);
    </script>
</body>

</html>